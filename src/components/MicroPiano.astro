---
// Remove the Props interface and props destructuring since we're not using them anymore
---

<div class="MicroPiano">
  <div class="MicroPiano_controlPanel">
    <div class="MicroPiano_widget _machine">
      <div class="MicroPiano_value">404</div>
      <div class="MicroPiano_label">× Machine ×</div>
    </div>
    <div class="MicroPiano_widget _octave">
      <div class="MicroPiano_value">
        <button class="MicroPiano_octaveEdit _down">-</button>
        <div class="MicroPiano_octaveValue">3</div>
        <button class="MicroPiano_octaveEdit _up">+</button>
      </div>
      <div class="MicroPiano_label">Octave</div>
    </div>
    <div class="MicroPiano_widget _apr">
      <label class="MicroPiano_value">
        <input type="checkbox" class="_arpState" />
        <span class="MicroPiano_valueLabels">
          <span class="_on">ON</span>
          <span class="_off">OFF</span>
        </span>
      </label>
      <div class="MicroPiano_label">Arpeggio</div>
    </div>
    <div class="MicroPiano_widget _pads">
      <button class="MicroPiano_pad _kick">
        <span class="MicroPiano_label">Boom</span>
      </button>
      <button class="MicroPiano_pad _snare">
        <span class="MicroPiano_label">Bap</span>
      </button>
      <button class="MicroPiano_pad _clap">
        <span class="MicroPiano_label">Clap</span>
      </button>
    </div>
  </div>
  <div class="MicroPiano_keyboard">
    {
      Array.from({ length: 2 }, (_, i) => (
        <div class="MicroPiano_octave" data-octave={i}>
          <div class="MicroPiano_key" data-note="C">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key _black _cd" data-note="C#">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key" data-note="D">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key _black _dd" data-note="D#">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key" data-note="E">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key" data-note="F">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key _black _fd" data-note="F#">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key" data-note="G">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key _black _gd" data-note="G#">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key" data-note="A">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key _black _ad" data-note="A#">
            <div class="MicroPiano_shortcut" />
          </div>
          <div class="MicroPiano_key" data-note="B">
            <div class="MicroPiano_shortcut" />
          </div>
        </div>
      ))
    }
  </div>
</div>

<script>
  class Piano {
    private audioContext: AudioContext;
    private oscillators: Map<string, OscillatorNode>;
    private keyMap: { [key: string]: { note: string; octaveOffset: number } };
    private currentOctave: number;
    private octaveDisplay: HTMLDivElement;
    private baseNotes: { [key: string]: number };
    private isArpeggioEnabled: boolean;
    private activeArpeggios: Set<string>;

    constructor() {
      this.audioContext = new AudioContext();
      this.oscillators = new Map();
      this.currentOctave = 4; // Starting octave
      this.octaveDisplay = document.querySelector(".MicroPiano_octaveValue")!;
      this.noteIndex = 0;
      // Base frequencies for octave 4
      this.baseNotes = {
        C: 261.63,
        "C#": 277.18,
        D: 293.66,
        "D#": 311.13,
        E: 329.63,
        F: 349.23,
        "F#": 369.99,
        G: 392.0,
        "G#": 415.3,
        A: 440.0,
        "A#": 466.16,
        B: 493.88,
      };

      this.isArpeggioEnabled = false;
      this.activeArpeggios = new Set();
      this.updateKeyMap();
      this.initializePiano();
      this.initializeOctaveControls();
      this.updateShortcutLabels();
      this.initializeArpeggioControl();
      this.initializeDrumPads();
    }

    private noteToFrequency(note: string): number {
      const [noteName, octave] = note.split(/(\d+)/).filter(Boolean);
      const baseFreq = this.baseNotes[noteName];
      if (!baseFreq) return 440; // Default frequency if note not found

      // Calculate frequency for the given octave
      // Using the formula: f = f0 * 2^(n-4) where f0 is the frequency in octave 4
      const octaveDiff = parseInt(octave) - 4;
      return baseFreq * Math.pow(2, octaveDiff);
    }

    private getMajorChordNotes(baseNote: string): string[] {
      const [noteName, octave] = baseNote.split(/(\d+)/).filter(Boolean);
      const octaveNum = parseInt(octave);

      const noteSequence = [
        "C",
        "C#",
        "D",
        "D#",
        "E",
        "F",
        "F#",
        "G",
        "G#",
        "A",
        "A#",
        "B",
      ];
      const baseIndex = noteSequence.indexOf(noteName);

      // Calculate indices for third and fifth, wrapping around the note sequence
      const thirdIndex = (baseIndex + 4) % 12;
      const fifthIndex = (baseIndex + 7) % 12;

      // Calculate octave adjustments
      const thirdOctave = octaveNum + Math.floor((baseIndex + 4) / 12);
      const fifthOctave = octaveNum + Math.floor((baseIndex + 7) / 12);

      return [
        baseNote,
        `${noteSequence[thirdIndex]}${thirdOctave}`,
        `${noteSequence[fifthIndex]}${fifthOctave}`,
      ];
    }

    private playNote(note: string, duration = 1) {
      const oscillator = this.audioContext.createOscillator();
      const gainNode = this.audioContext.createGain();

      oscillator.type = "sine";
      oscillator.frequency.setValueAtTime(
        this.noteToFrequency(note),
        this.audioContext.currentTime
      );

      gainNode.gain.setValueAtTime(0.5, this.audioContext.currentTime);
      gainNode.gain.setTargetAtTime(
        0,
        this.audioContext.currentTime + 0.1,
        0.2
      );

      oscillator.connect(gainNode);
      gainNode.connect(this.audioContext.destination);

      oscillator.start();
      oscillator.stop(this.audioContext.currentTime + duration);

      this.oscillators.set(note, oscillator);
    }

    private playArpeggio(baseNote: string) {
      if (this.activeArpeggios.has(baseNote)) return;

      const chordNotes = this.getMajorChordNotes(baseNote);
      let noteIndex = 0;

      const playNextNote = () => {
        if (!this.activeArpeggios.has(baseNote)) return;

        this.playNote(chordNotes[noteIndex], 0.3);
        noteIndex = (noteIndex + 1) % chordNotes.length;
        setTimeout(playNextNote, 200);
      };

      this.activeArpeggios.add(baseNote);
      playNextNote();
    }

    private handleNoteStart(note: string) {
      if (this.isArpeggioEnabled) {
        this.playArpeggio(note);
      } else {
        this.playNote(note);
      }
    }

    private handleNoteEnd(note: string) {
      if (this.isArpeggioEnabled) {
        this.activeArpeggios.delete(note);
      }
    }

    private getNoteWithOctave(key: Element): string {
      const note = key.getAttribute("data-note");
      const octaveElement = key.closest(".MicroPiano_octave");
      if (!note || !octaveElement) return "";

      const octaveOffset = parseInt(
        octaveElement.getAttribute("data-octave") || "0"
      );
      return `${note}${this.currentOctave + octaveOffset}`;
    }

    private getKeyboardNoteWithOctave(keyMapping: {
      note: string;
      octaveOffset: number;
    }): string {
      return `${keyMapping.note}${this.currentOctave + keyMapping.octaveOffset}`;
    }

    private initializePiano() {
      const keys = document.querySelectorAll(".MicroPiano_key");

      keys.forEach((key) => {
        // Mouse events
        key.addEventListener("mousedown", () => {
          const noteWithOctave = this.getNoteWithOctave(key);
          if (noteWithOctave) {
            this.handleNoteStart(noteWithOctave);
            key.classList.add("active");
          }
        });

        key.addEventListener("mouseup", () => {
          const noteWithOctave = this.getNoteWithOctave(key);
          if (noteWithOctave) {
            this.handleNoteEnd(noteWithOctave);
          }
          key.classList.remove("active");
        });

        key.addEventListener("mouseleave", () => {
          const noteWithOctave = this.getNoteWithOctave(key);
          if (noteWithOctave) {
            this.handleNoteEnd(noteWithOctave);
          }
          key.classList.remove("active");
        });

        // Touch events
        key.addEventListener("touchstart", (e) => {
          e.preventDefault();
          const noteWithOctave = this.getNoteWithOctave(key);
          if (noteWithOctave) {
            this.handleNoteStart(noteWithOctave);
            key.classList.add("active");
          }
        });

        key.addEventListener("touchend", () => {
          const noteWithOctave = this.getNoteWithOctave(key);
          if (noteWithOctave) {
            this.handleNoteEnd(noteWithOctave);
          }
          key.classList.remove("active");
        });
      });

      // Keyboard events
      document.addEventListener("keydown", (e) => {
        const keyMapping = this.keyMap[e.key.toLowerCase()];
        if (keyMapping && !e.repeat) {
          const noteWithOctave = this.getKeyboardNoteWithOctave(keyMapping);
          this.handleNoteStart(noteWithOctave);
          const key = document.querySelector(
            `.MicroPiano_octave[data-octave="${keyMapping.octaveOffset}"] [data-note="${keyMapping.note}"]`
          );
          key?.classList.add("active");
        }
      });

      document.addEventListener("keyup", (e) => {
        const keyMapping = this.keyMap[e.key.toLowerCase()];
        if (keyMapping) {
          const noteWithOctave = this.getKeyboardNoteWithOctave(keyMapping);
          this.handleNoteEnd(noteWithOctave);
          const key = document.querySelector(
            `.MicroPiano_octave[data-octave="${keyMapping.octaveOffset}"] [data-note="${keyMapping.note}"]`
          );
          key?.classList.remove("active");
        }
      });
    }

    private updateKeyMap() {
      this.keyMap = {
        q: { note: "C", octaveOffset: 0 },
        2: { note: "C#", octaveOffset: 0 },
        w: { note: "D", octaveOffset: 0 },
        3: { note: "D#", octaveOffset: 0 },
        e: { note: "E", octaveOffset: 0 },
        r: { note: "F", octaveOffset: 0 },
        5: { note: "F#", octaveOffset: 0 },
        t: { note: "G", octaveOffset: 0 },
        6: { note: "G#", octaveOffset: 0 },
        y: { note: "A", octaveOffset: 0 },
        7: { note: "A#", octaveOffset: 0 },
        u: { note: "B", octaveOffset: 0 },
        //
        z: { note: "C", octaveOffset: 1 },
        s: { note: "C#", octaveOffset: 1 },
        x: { note: "D", octaveOffset: 1 },
        d: { note: "D#", octaveOffset: 1 },
        c: { note: "E", octaveOffset: 1 },
        v: { note: "F", octaveOffset: 1 },
        g: { note: "F#", octaveOffset: 1 },
        b: { note: "G", octaveOffset: 1 },
        h: { note: "G#", octaveOffset: 1 },
        n: { note: "A", octaveOffset: 1 },
        j: { note: "A#", octaveOffset: 1 },
        m: { note: "B", octaveOffset: 1 },
      };
    }

    private initializeOctaveControls() {
      const octaveUp = document.querySelector(".MicroPiano_octaveEdit._up");
      const octaveDown = document.querySelector(".MicroPiano_octaveEdit._down");

      const handleOctaveUp = () => {
        if (this.currentOctave < 6) {
          this.currentOctave++;
          this.updateOctaveDisplay();
        }
      };

      const handleOctaveDown = () => {
        if (this.currentOctave > 2) {
          this.currentOctave--;
          this.updateOctaveDisplay();
        }
      };

      // Mouse click handlers
      octaveUp?.addEventListener("click", handleOctaveUp);
      octaveDown?.addEventListener("click", handleOctaveDown);

      // Keyboard handlers
      document.addEventListener("keydown", (e) => {
        if (e.key === "=" || e.key === "+") {
          handleOctaveUp();
        } else if (e.key === "-" || e.key === "_") {
          handleOctaveDown();
        }
      });

      // Initialize display
      this.updateOctaveDisplay();
    }

    private updateOctaveDisplay() {
      if (this.octaveDisplay) {
        this.octaveDisplay.textContent = this.currentOctave.toString();
      }
    }

    private findKeyForNote(noteToFind: string, octaveOffset: number): string {
      for (const [key, mapping] of Object.entries(this.keyMap)) {
        if (
          mapping.note === noteToFind &&
          mapping.octaveOffset === octaveOffset
        ) {
          return key;
        }
      }
      return "";
    }

    private updateShortcutLabels() {
      const keys = document.querySelectorAll(".MicroPiano_key");
      keys.forEach((key) => {
        const note = key.getAttribute("data-note");
        const octaveElement = key.closest(".MicroPiano_octave");
        if (!note || !octaveElement) return;

        const octaveOffset = parseInt(
          octaveElement.getAttribute("data-octave") || "0"
        );

        const shortcut = this.findKeyForNote(note, octaveOffset);
        const shortcutElement = key.querySelector(".MicroPiano_shortcut");
        if (shortcutElement) {
          shortcutElement.textContent = shortcut;
        }
      });
    }

    private initializeArpeggioControl() {
      const arpCheckbox = document.querySelector(
        "._arpState"
      ) as HTMLInputElement;

      if (arpCheckbox) {
        arpCheckbox.addEventListener("change", (e) => {
          this.isArpeggioEnabled = (e.target as HTMLInputElement).checked;
          if (!this.isArpeggioEnabled) {
            this.activeArpeggios.clear();
          }
        });
      }
    }

    private initializeDrumPads() {
      const kickPad = document.querySelector(".MicroPiano_pad._kick");
      const snarePad = document.querySelector(".MicroPiano_pad._snare");
      const clapPad = document.querySelector(".MicroPiano_pad._clap");

      kickPad?.addEventListener("click", () => this.playKick());
      snarePad?.addEventListener("click", () => this.playSnare());
      clapPad?.addEventListener("click", () => this.playClap());

      // Add keyboard shortcuts for drums
      document.addEventListener("keydown", (e) => {
        if (e.repeat) return;

        switch (e.key.toLowerCase()) {
          case "8":
            this.playKick();
            kickPad?.classList.add("active");
            break;
          case "9":
            this.playSnare();
            snarePad?.classList.add("active");
            break;
          case "0":
            this.playClap();
            clapPad?.classList.add("active");
            break;
        }
      });

      document.addEventListener("keyup", (e) => {
        switch (e.key.toLowerCase()) {
          case "8":
            kickPad?.classList.remove("active");
            break;
          case "9":
            snarePad?.classList.remove("active");
            break;
          case "0":
            clapPad?.classList.remove("active");
            break;
        }
      });
    }

    private playKick() {
      const oscillator = this.audioContext.createOscillator();
      const gainNode = this.audioContext.createGain();

      oscillator.frequency.setValueAtTime(150, this.audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(
        0.01,
        this.audioContext.currentTime + 0.5
      );

      gainNode.gain.setValueAtTime(1, this.audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(
        0.001,
        this.audioContext.currentTime + 0.5
      );

      oscillator.connect(gainNode);
      gainNode.connect(this.audioContext.destination);

      oscillator.start(this.audioContext.currentTime);
      oscillator.stop(this.audioContext.currentTime + 0.5);
    }

    private playSnare() {
      const bufferSize = this.audioContext.sampleRate * 0.15;
      const buffer = this.audioContext.createBuffer(
        1,
        bufferSize,
        this.audioContext.sampleRate
      );
      const output = buffer.getChannelData(0);

      // White noise
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }

      const noise = this.audioContext.createBufferSource();
      noise.buffer = buffer;

      const noiseGain = this.audioContext.createGain();
      noiseGain.gain.setValueAtTime(1, this.audioContext.currentTime);
      noiseGain.gain.exponentialRampToValueAtTime(
        0.01,
        this.audioContext.currentTime + 0.15
      );

      // Snare body
      const oscillator = this.audioContext.createOscillator();
      const oscillatorGain = this.audioContext.createGain();

      oscillator.type = "triangle";
      oscillator.frequency.setValueAtTime(100, this.audioContext.currentTime);
      oscillatorGain.gain.setValueAtTime(0.7, this.audioContext.currentTime);
      oscillatorGain.gain.exponentialRampToValueAtTime(
        0.01,
        this.audioContext.currentTime + 0.1
      );

      noise.connect(noiseGain);
      oscillator.connect(oscillatorGain);
      noiseGain.connect(this.audioContext.destination);
      oscillatorGain.connect(this.audioContext.destination);

      noise.start();
      oscillator.start();
      noise.stop(this.audioContext.currentTime + 0.15);
      oscillator.stop(this.audioContext.currentTime + 0.15);
    }

    private playClap() {
      const bufferSize = this.audioContext.sampleRate * 0.1;
      const buffer = this.audioContext.createBuffer(
        1,
        bufferSize,
        this.audioContext.sampleRate
      );
      const output = buffer.getChannelData(0);

      // White noise
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }

      const noise = this.audioContext.createBufferSource();
      noise.buffer = buffer;

      // Bandpass filter for clap character
      const bandpass = this.audioContext.createBiquadFilter();
      bandpass.type = "bandpass";
      bandpass.frequency.value = 1000;
      bandpass.Q.value = 1.5;

      const gainNode = this.audioContext.createGain();
      gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
      gainNode.gain.linearRampToValueAtTime(
        1,
        this.audioContext.currentTime + 0.02
      );
      gainNode.gain.exponentialRampToValueAtTime(
        0.01,
        this.audioContext.currentTime + 0.1
      );

      noise.connect(bandpass);
      bandpass.connect(gainNode);
      gainNode.connect(this.audioContext.destination);

      noise.start();
      noise.stop(this.audioContext.currentTime + 0.1);
    }
  }

  // Initialize piano when the component is mounted
  document.addEventListener("DOMContentLoaded", () => {
    new Piano();
  });
</script>

<style>
  .MicroPiano {
    display: grid;
    grid-template-rows: 80px 160px;

    box-sizing: border-box;

    width: 600px;
    height: 240px;

    background: var(--color-underpaper);
    border: 1px solid var(--color-white-20);
    box-shadow: 8px 8px 0px var(--color-black-30);
    border-radius: 8px 24px 8px 8px;

    overflow: hidden;
    user-select: none;
  }

  .MicroPiano_keyboard {
    width: 100%;
    height: 100%;

    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    border-top: 1px solid var(--color-white-20);
  }

  .MicroPiano_octave {
    /* width: 100%; */
    height: 100%;
    position: relative;
    display: flex;
  }

  .MicroPiano_shortcut {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;

    font-weight: 400;
    font-size: 11px;
    line-height: 10px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: -0.021em;
    background-color: var(--color-black-50);
    color: var(--color-white-40);

    border-radius: 4px;
  }

  .MicroPiano_key {
    --key-width: calc(100% / 7);
    width: var(--key-width);
    height: 100%;
    min-width: 40px;
    min-height: 80px;

    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: end;

    padding-bottom: 12px;

    background: var(--color-underpaper);
    border-color: var(--color-white-20);
    border-style: solid;
    border-width: 0;
    border-right-width: 1px;
    border-radius: 0;
    cursor: pointer;
    position: relative;
    z-index: 1;
    transition: background-color 0.1s;
    /* margin-right: -1px; */

    box-sizing: border-box;
  }
  .MicroPiano_octave:last-of-type .MicroPiano_key:last-of-type {
    border-right-width: 0;
  }

  .MicroPiano_key._black {
    border-bottom-width: 1px;
    border-right-width: 1px;
    height: 50%;
    min-height: 40px;
    position: absolute;
    z-index: 2;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
  }

  .MicroPiano_key._cd {
    left: calc(var(--key-width) - var(--key-width) / 2);
    border-left-width: 1px;
  }
  .MicroPiano_key._dd {
    left: calc(var(--key-width) * 2 - var(--key-width) / 2);
  }
  .MicroPiano_key._fd {
    left: calc(var(--key-width) * 4 - var(--key-width) / 2);
    border-left-width: 1px;
  }
  .MicroPiano_key._gd {
    left: calc(var(--key-width) * 5 - var(--key-width) / 2);
  }
  .MicroPiano_key._ad {
    left: calc(var(--key-width) * 6 - var(--key-width) / 2);
  }

  .MicroPiano_key.active {
    background: var(--color-green);
  }

  .MicroPiano_controlPanel {
    display: flex;
    flex-direction: row;
    gap: 24px;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    height: 100%;
  }

  .MicroPiano_widget {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .MicroPiano_label {
    font-size: 11px;
    line-height: 10px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: -0.021em;

    color: var(--color-white-20);
  }

  .MicroPiano_value {
    /* 404 */
    display: flex;
    flex-direction: row;
    font-weight: 100;
    font-size: 48px;
    line-height: 48px;
    text-align: center;
    letter-spacing: -0.05em;
    color: var(--color-white-20);
  }

  .MicroPiano_octaveEdit {
    background: none;
    border: none;
    font: inherit;
    color: inherit;
  }

  .MicroPiano_widget._apr ._arpState {
    display: none;
  }

  .MicroPiano_widget._apr .MicroPiano_valueLabels {
    width: 80px;
    text-align: center;
  }

  .MicroPiano_widget._apr ._on {
    display: none;
  }
  .MicroPiano_widget._apr ._off {
    display: initial;
  }

  .MicroPiano_widget._apr ._arpState:checked + .MicroPiano_valueLabels ._on {
    display: initial;
  }
  .MicroPiano_widget._apr ._arpState:checked + .MicroPiano_valueLabels ._off {
    display: none;
  }

  .MicroPiano_widget._pads {
    display: flex;
    flex-direction: row;
    gap: 8px;
    height: 100%;
    align-items: center;
    justify-content: center;
  }
  .MicroPiano_pad {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: 1px solid var(--color-white-20);
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    cursor: pointer;
    transition: background-color 0.1s;
  }

  .MicroPiano_pad:focus {
    outline: none;
  }

  .MicroPiano_pad.active,
  .MicroPiano_pad:active {
    background: var(--color-green);
  }
</style>
